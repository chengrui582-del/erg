<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>City Social</title>
<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:"Segoe UI",sans-serif;
  color:#fff;
  background:linear-gradient(#050b16,#0f2027,#203a43);
  overflow-x:hidden;
}
.hidden{display:none}
header{
  position:sticky;top:0;z-index:10;
  background:rgba(0,0,0,.6);
  padding:12px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{border:none;border-radius:6px;padding:6px 12px;cursor:pointer}
input,textarea{width:100%;padding:8px;border-radius:6px;border:none;margin:5px 0}
#loginBox,#registerBox{max-width:380px;margin:80px auto;background:rgba(0,0,0,.65);padding:20px;border-radius:12px}
#app{max-width:900px;margin:20px auto;display:flex;gap:20px}
#left{flex:2}#right{flex:1}
.card{background:rgba(0,0,0,.55);padding:12px;border-radius:12px;margin-bottom:15px}
.post img{max-width:100%;border-radius:10px;margin-top:8px}
.small{font-size:12px;opacity:.8}
.action span{margin-right:10px;cursor:pointer}
.city{
  position:fixed;bottom:0;left:0;right:0;
  height:180px;pointer-events:none;
  background:repeating-linear-gradient(to right,#000 0 20px,#111 20px 40px);
  opacity:.6;
}
.city:before{
  content:"";
  position:absolute;inset:0;
  background:repeating-linear-gradient(to right,transparent 0 18px,#ffd700 18px 20px);
  animation:lights 3s infinite alternate;
}
@keyframes lights{from{opacity:.3}to{opacity:.8}}
.list-item{display:flex;justify-content:space-between;margin:4px 0}
</style>
</head>
<body>

<div class="city"></div>

<header id="top" class="hidden">
  <b>ğŸŒƒ City Social</b>
  <div>
    <span id="me"></span>
    <button onclick="logout()">ç™»å‡º</button>
  </div>
</header>

<div id="loginBox">
  <h2>ç™»å…¥</h2>
  <input id="l_user" placeholder="å¸³è™Ÿ">
  <input id="l_pass" type="password" placeholder="å¯†ç¢¼">
  <button onclick="login()">ç™»å…¥</button>
  <p onclick="showRegister()" style="cursor:pointer">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
  <p id="l_msg"></p>
</div>

<div id="registerBox" class="hidden">
  <h2>è¨»å†Š</h2>
  <input id="r_user" placeholder="å¸³è™Ÿ">
  <input id="r_pass" type="password" placeholder="å¯†ç¢¼">
  <button onclick="register()">è¨»å†Š</button>
  <p onclick="showLogin()" style="cursor:pointer">å›ç™»å…¥</p>
  <p id="r_msg"></p>
</div>

<div id="app" class="hidden">
  <div id="left">

    <div class="card">
      <h3>ğŸ“ ç™¼æ–‡</h3>
      <textarea id="postText" placeholder="ä»Šå¤©åŸå¸‚è£¡ç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ"></textarea>
      <input type="file" id="postImg">
      <button onclick="addPost()">ç™¼ä½ˆ</button>
    </div>

    <div id="posts"></div>

  </div>

  <div id="right">

    <div class="card">
      <h3>ğŸ‘¤ å€‹äºº</h3>
      æš±ç¨±
      <input id="nickname">
      <button onclick="saveProfile()">å„²å­˜</button>
      <p class="small">
        å¥½å‹ <span id="friendCount">0</span> ï½œ  
        è¿½è¹¤ <span id="followCount">0</span> ï½œ  
        ç²‰çµ² <span id="fanCount">0</span>
      </p>
    </div>

    <div class="card">
      <h3>ğŸ‘¥ å¥½å‹æ¸…å–®</h3>
      <div id="friendList"></div>
    </div>

    <div class="card">
      <h3>ğŸ’¬ ç§è¨ŠèŠå¤©</h3>
      <div id="chatList"></div>
    </div>

  </div>
</div>

<script>
/* ---------- å·¥å…· ---------- */
const db=k=>JSON.parse(localStorage.getItem(k)||"[]");
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
["users","posts","friends","follows","chats"].forEach(k=>{if(!localStorage[k])save(k,[])});
let current=localStorage.currentUser||null;

/* ---------- é¡¯ç¤º ---------- */
function showApp(){
  loginBox.classList.add("hidden");
  registerBox.classList.add("hidden");
  app.classList.remove("hidden");
  top.classList.remove("hidden");
  me.textContent=current;
  loadProfile();renderPosts();renderFriends();renderChats();
}
if(current)showApp();

/* ---------- ç™»å…¥ / è¨»å†Š ---------- */
function register(){
  const u=r_user.value.trim(),p=r_pass.value;
  if(!u||!p)return r_msg.textContent="è«‹å¡«å®Œæ•´";
  const users=db("users");
  if(users.find(x=>x.u===u))return r_msg.textContent="å¸³è™Ÿå­˜åœ¨";
  users.push({u,p,nick:u});
  save("users",users);
  r_msg.textContent="âœ… è¨»å†ŠæˆåŠŸ";
}
function login(){
  const u=l_user.value.trim(),p=l_pass.value;
  if(!db("users").find(x=>x.u===u&&x.p===p))return l_msg.textContent="éŒ¯èª¤";
  current=u;localStorage.currentUser=u;showApp();
}
function logout(){
  if(!confirm("ç¢ºå®šç™»å‡ºï¼Ÿ"))return;
  localStorage.removeItem("currentUser");
  location.reload();
}
function showRegister(){loginBox.classList.add("hidden");registerBox.classList.remove("hidden")}
function showLogin(){registerBox.classList.add("hidden");loginBox.classList.remove("hidden")}

/* ---------- å€‹äºº ---------- */
function loadProfile(){
  const u=db("users").find(x=>x.u===current);
  nickname.value=u.nick;
  friendCount.textContent=db("friends").filter(f=>f.a===current||f.b===current).length;
  followCount.textContent=db("follows").filter(f=>f.from===current).length;
  fanCount.textContent=db("follows").filter(f=>f.to===current).length;
}
function saveProfile(){
  const users=db("users");
  users.find(x=>x.u===current).nick=nickname.value.trim();
  save("users",users);
}

/* ---------- è²¼æ–‡ ---------- */
function addPost(){
  if(!postText.value.trim())return;
  const imgFile=postImg.files[0];
  const posts=db("posts");
  const finish=(img)=>{
    posts.unshift({id:Date.now(),user:current,text:postText.value,img,likes:[],comments:[]});
    save("posts",posts);
    postText.value="";postImg.value="";
    renderPosts();
  }
  if(imgFile){
    const r=new FileReader();
    r.onload=()=>finish(r.result);
    r.readAsDataURL(imgFile);
  }else finish(null);
}
function renderPosts(){
  posts.innerHTML="";
  db("posts").forEach(p=>{
    const d=document.createElement("div");
    d.className="card post";
    d.innerHTML=`
<b>${p.user}</b>
<p>${p.text}</p>
${p.img?`<img src="${p.img}">`:""}
<div class="action">
<span onclick="like(${p.id})">â¤ï¸ ${p.likes.length}</span>
<span onclick="comment(${p.id})">ğŸ’¬ ${p.comments.length}</span>
${p.user!==current?`<span onclick="addFriend('${p.user}')">â• åŠ å¥½å‹</span>
<span onclick="follow('${p.user}')">â­ è¿½è¹¤</span>`:"<span class='small'>(ä½ çš„è²¼æ–‡)</span>"}
</div>
${p.comments.map(c=>`<div class="small">${c.u}: ${c.t}</div>`).join("")}
`;
    posts.appendChild(d);
  });
}
function like(id){
  const posts=db("posts");
  const p=posts.find(x=>x.id===id);
  if(!p.likes.includes(current))p.likes.push(current);
  save("posts",posts);renderPosts();
}
function comment(id){
  const t=prompt("ç•™è¨€");
  if(!t)return;
  const posts=db("posts");
  posts.find(x=>x.id===id).comments.push({u:current,t});
  save("posts",posts);renderPosts();
}

/* ---------- å¥½å‹ / è¿½è¹¤ ---------- */
function addFriend(u){
  if(u===current)return alert("ä¸èƒ½åŠ è‡ªå·±");
  const f=db("friends");
  if(f.find(x=>(x.a===current&&x.b===u)||(x.a===u&&x.b===current)))return alert("å·²æ˜¯å¥½å‹");
  f.push({a:current,b:u});
  save("friends",f);loadProfile();renderFriends();renderChats();
}
function follow(u){
  const f=db("follows");
  if(!f.find(x=>x.from===current&&x.to===u)){
    f.push({from:current,to:u});
    save("follows",f);loadProfile();
  }
}
function renderFriends(){
  friendList.innerHTML="";
  db("friends").filter(f=>f.a===current||f.b===current)
    .forEach(f=>{
      const u=f.a===current?f.b:f.a;
      friendList.innerHTML+=`<div class="list-item">${u}</div>`;
    });
}

/* ---------- ç§è¨Š ---------- */
function renderChats(){
  chatList.innerHTML="";
  db("friends").filter(f=>f.a===current||f.b===current)
    .forEach(f=>{
      const u=f.a===current?f.b:f.a;
      chatList.innerHTML+=
      `<div class="list-item">
        ${u}
        <button onclick="chat('${u}')">èŠ</button>
      </div>`;
    });
}
function chat(u){
  const t=prompt(`å‚³è¨Šçµ¦ ${u}`);
  if(!t)return;
  const c=db("chats");
  c.push({a:current,b:u,t,ts:Date.now()});
  save("chats",c);
  alert("å·²é€å‡º");
}
</script>
</body>
</html>
