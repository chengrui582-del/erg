<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç¤¾äº¤ç¶²ç«™å®Œæ•´ç‰ˆ</title>
<style>
body { font-family: Arial; margin:0; background:#f0f2f5; }
header { background:#4267B2; color:white; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; }
header h1 { margin:0; }
nav a { color:white; margin-left:15px; text-decoration:none; font-weight:bold; cursor:pointer; }
.container { display:flex; max-width:1200px; margin:20px auto; gap:20px; }
.sidebar { flex:1; background:white; padding:15px; border-radius:10px; height:fit-content; }
.feed { flex:2; display:flex; flex-direction:column; gap:20px; }
.post, .friend { background:white; padding:15px; border-radius:10px; }
.post-header { display:flex; align-items:center; gap:10px; }
.post-header img { width:40px; height:40px; border-radius:50%; }
.post-content { margin:10px 0; }
.post-actions { display:flex; gap:10px; }
.post-actions button { cursor:pointer; padding:5px 10px; border:none; border-radius:5px; background:#e4e6eb; }
.friend img { width:40px; height:40px; border-radius:50%; margin-right:10px; vertical-align:middle; }
input[type=text], input[type=email], input[type=password] { width:100%; padding:8px; border-radius:5px; border:1px solid #ccc; margin-bottom:5px; }
button.send { width:100%; background:#4267B2; color:white; padding:8px; border:none; border-radius:5px; cursor:pointer; }
#authContainer { max-width:400px; margin:50px auto; background:white; padding:20px; border-radius:10px; }
</style>
</head>
<body>

<header style="display:none;" id="mainHeader">
  <h1>ç¤¾äº¤ç¶²ç«™ Demo</h1>
  <nav>
    <a onclick="showSection('feed')">é¦–é </a>
    <a onclick="showSection('profile')">å€‹äººé </a>
    <a onclick="showSection('friends')">å¥½å‹åˆ—è¡¨</a>
    <a onclick="logout()">ç™»å‡º</a>
  </nav>
</header>

<div id="authContainer">
  <h2>è¨»å†Š / ç™»å…¥</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="text" id="username" placeholder="ä½¿ç”¨è€…åç¨± (è¨»å†Šç”¨)">
  <input type="password" id="password" placeholder="å¯†ç¢¼">
  <button onclick="register()">è¨»å†Š</button>
  <button onclick="login()">ç™»å…¥</button>
  <p id="authMsg" style="color:red;"></p>
</div>

<div class="container" id="feedContainer" style="display:none;">
  <div class="feed" id="feed">
    <div style="background:white; padding:15px; border-radius:10px;">
      <input type="text" id="newPost" placeholder="ä½ åœ¨æƒ³ä»€éº¼ï¼Ÿ">
      <button class="send" onclick="addPost()">ç™¼ä½ˆ</button>
    </div>
  </div>
  <div class="sidebar">
    <h3>å¥½å‹åˆ—è¡¨</h3>
    <div id="friendList"></div>
  </div>
</div>

<div class="container" id="profileContainer" style="display:none;">
  <div class="feed" id="profileFeed"></div>
</div>

<div class="container" id="friendsContainer" style="display:none;">
  <div class="sidebar" id="myFriends"></div>
</div>

<script>
const API = "http://localhost:3000/api";
let token = "";
let currentUser = {};

function register(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const username = document.getElementById('username').value;
  fetch(API+'/register',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,password,username})
  }).then(res=>res.json()).then(res=>{
    document.getElementById('authMsg').textContent = res.message || res.error;
  });
}

function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  fetch(API+'/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({email,password})
  }).then(res=>res.json()).then(res=>{
    if(res.token){
      token = res.token;
      currentUser = {username: res.username, avatar: res.avatar};
      document.getElementById('authContainer').style.display='none';
      document.getElementById('mainHeader').style.display='flex';
      document.getElementById('feedContainer').style.display='flex';
      loadPosts();
      loadFriends();
    } else {
      document.getElementById('authMsg').textContent = res.error;
    }
  });
}

function logout(){
  token = "";
  currentUser = {};
  document.getElementById('mainHeader').style.display='none';
  document.getElementById('feedContainer').style.display='none';
  document.getElementById('profileContainer').style.display='none';
  document.getElementById('friendsContainer').style.display='none';
  document.getElementById('authContainer').style.display='block';
}

function authFetch(url, options={}){
  options.headers = options.headers || {};
  options.headers['Authorization'] = token;
  return fetch(url, options).then(res=>res.json());
}

// è²¼æ–‡
function loadPosts(){
  authFetch(API+'/posts').then(posts=>{
    const feed = document.getElementById('feed');
    feed.innerHTML = `<div style="background:white; padding:15px; border-radius:10px;">
      <input type="text" id="newPost" placeholder="ä½ åœ¨æƒ³ä»€éº¼ï¼Ÿ">
      <button class="send" onclick="addPost()">ç™¼ä½ˆ</button>
    </div>`;
    posts.forEach((p,i)=>{
      const div = document.createElement('div');
      div.className='post';
      const user = p.userId;
      let commentsHtml = '';
      p.comments.forEach(c=>{
        commentsHtml += `<p><strong>${c.userId.username}:</strong> ${c.comment}</p>`;
      });
      div.innerHTML = `
        <div class="post-header">
          <img src="${user.avatarUrl||'https://via.placeholder.com/40'}">
          <strong>${user.username}</strong>
        </div>
        <div class="post-content">${p.content}</div>
        <div class="post-actions">
          <button onclick="likePost('${p._id}')">ğŸ‘ æŒ‰è®š (${p.likes.length})</button>
          <button onclick="commentPost('${p._id}')">ğŸ’¬ ç•™è¨€ (${p.comments.length})</button>
        </div>
        <div class="comments">${commentsHtml}</div>
      `;
      feed.appendChild(div);
    });
  });
}

function addPost(){
  const content = document.getElementById('newPost').value;
  if(!content) return;
  authFetch(API+'/posts',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({content})
  }).then(()=>{ document.getElementById('newPost').value=''; loadPosts(); });
}

function likePost(id){
  authFetch(API+`/posts/${id}/like`, {method:'POST'}).then(()=>loadPosts());
}

function commentPost(id){
  const comment = prompt("è¼¸å…¥ç•™è¨€ï¼š");
  if(comment){
    authFetch(API+`/posts/${id}/comment`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({comment})
    }).then(()=>loadPosts());
  }
}

// å¥½å‹
function loadFriends(){
  authFetch(API+'/friends').then(friends=>{
    const list = document.getElementById('friendList');
    list.innerHTML='';
    const myList = document.getElementById('myFriends');
    myList.innerHTML='';
    friends.forEach(f=>{
      const div = document.createElement('div');
      div.className='friend';
      div.innerHTML=`<img src="${f.avatarUrl||'https://via.placeholder.com/40'}">${f.username} <button onclick="addFriend('${f._id}')">è¿½è¹¤</button>`;
      list.appendChild(div.cloneNode(true));
      myList.appendChild(div);
    });
  });
}

function addFriend(id){
  authFetch(API+`/friends/${id}`, {method:'POST'}).then(()=>loadFriends());
}

// åˆ‡æ›é é¢
function showSection(section){
  document.getElementById('feedContainer').style.display = section==='feed'?'flex':'none';
  document.getElementById('profileContainer').style.display = section==='profile'?'flex':'none';
  document.getElementById('friendsContainer').style.display = section==='friends'?'flex':'none';
}

</script>
</body>
</html>
