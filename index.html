<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>City Social</title>
<style>
body{
  margin:0;font-family:"Segoe UI";
  background:linear-gradient(180deg,#0f2027,#203a43,#2c5364);
  color:#fff;
}
.hidden{display:none}
header{
  background:rgba(0,0,0,.4);
  padding:15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  border:none;border-radius:6px;
  padding:6px 12px;cursor:pointer;
}
input,textarea{
  width:100%;padding:8px;
  border-radius:6px;border:none;
  margin:6px 0;
}
#loginBox,#registerBox{
  max-width:380px;
  margin:80px auto;
  background:rgba(0,0,0,.6);
  padding:20px;border-radius:10px;
}
#feed{max-width:600px;margin:20px auto}
.post{
  background:rgba(0,0,0,.5);
  padding:12px;border-radius:10px;
  margin-bottom:15px;
}
.small{font-size:12px;opacity:.8}
.action span{margin-right:10px;cursor:pointer}
.profile{
  background:rgba(0,0,0,.5);
  padding:15px;border-radius:10px;
  margin-bottom:20px;
}
</style>
</head>
<body>

<header id="top" class="hidden">
  <div>ğŸŒƒ City Social</div>
  <div>
    <span id="me"></span>
    <button onclick="logout()">ç™»å‡º</button>
  </div>
</header>

<!-- ç™»å…¥ -->
<div id="loginBox">
  <h2>ç™»å…¥</h2>
  <input id="l_user" placeholder="å¸³è™Ÿ">
  <input id="l_pass" type="password" placeholder="å¯†ç¢¼">
  <button onclick="login()">ç™»å…¥</button>
  <p onclick="showRegister()" style="cursor:pointer">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Š</p>
  <p id="l_msg"></p>
</div>

<!-- è¨»å†Š -->
<div id="registerBox" class="hidden">
  <h2>è¨»å†Š</h2>
  <input id="r_user" placeholder="å¸³è™Ÿ">
  <input id="r_pass" type="password" placeholder="å¯†ç¢¼">
  <button onclick="register()">è¨»å†Š</button>
  <p onclick="showLogin()" style="cursor:pointer">å›ç™»å…¥</p>
  <p id="r_msg"></p>
</div>

<!-- ä¸»ç•«é¢ -->
<div id="main" class="hidden">
  <div id="feed">

    <div class="profile">
      <h3>ğŸ‘¤ å€‹äººé </h3>
      æš±ç¨±ï¼š
      <input id="nickname">
      <button onclick="saveProfile()">å„²å­˜</button>
      <p class="small">å¥½å‹æ•¸ï¼š<span id="friendCount">0</span></p>
    </div>

    <textarea id="postText" placeholder="ä»Šå¤©åŸå¸‚è£¡ç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ"></textarea>
    <button onclick="addPost()">ç™¼ä½ˆ</button>

    <div id="posts"></div>
  </div>
</div>

<script>
/* ---------- å·¥å…· ---------- */
const db=k=>JSON.parse(localStorage.getItem(k)||"[]");
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

if(!localStorage.users) save("users",[]);
if(!localStorage.posts) save("posts",[]);
if(!localStorage.friends) save("friends",[]);

let current = localStorage.currentUser || null;

/* ---------- é¡¯ç¤º ---------- */
function showApp(){
  loginBox.classList.add("hidden");
  registerBox.classList.add("hidden");
  main.classList.remove("hidden");
  top.classList.remove("hidden");
  me.textContent=current;
  loadProfile();
  renderPosts();
}
if(current) showApp();

/* ---------- è¨»å†Š / ç™»å…¥ ---------- */
function register(){
  const u=r_user.value.trim(),p=r_pass.value;
  if(!u||!p) return r_msg.textContent="è«‹å¡«å®Œæ•´";
  const users=db("users");
  if(users.find(x=>x.u===u)) return r_msg.textContent="å¸³è™Ÿå­˜åœ¨";
  users.push({u,p,nick:u});
  save("users",users);
  r_msg.textContent="âœ… è¨»å†ŠæˆåŠŸ";
}
function login(){
  const u=l_user.value.trim(),p=l_pass.value;
  const users=db("users");
  if(!users.find(x=>x.u===u&&x.p===p))
    return l_msg.textContent="å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
  current=u;
  localStorage.currentUser=u;
  showApp();
}
function logout(){
  if(!confirm("ç¢ºå®šç™»å‡ºï¼Ÿ")) return;
  localStorage.removeItem("currentUser");
  current=null;
  location.reload();
}
function showRegister(){
  loginBox.classList.add("hidden");
  registerBox.classList.remove("hidden");
}
function showLogin(){
  registerBox.classList.add("hidden");
  loginBox.classList.remove("hidden");
}

/* ---------- å€‹äººé  ---------- */
function loadProfile(){
  const u=db("users").find(x=>x.u===current);
  nickname.value=u.nick;
  friendCount.textContent=db("friends")
    .filter(f=>f.a===current||f.b===current).length;
}
function saveProfile(){
  const users=db("users");
  users.find(x=>x.u===current).nick=nickname.value.trim();
  save("users",users);
}

/* ---------- è²¼æ–‡ ---------- */
function addPost(){
  if(!postText.value.trim()) return;
  const posts=db("posts");
  posts.unshift({
    id:Date.now(),
    user:current,
    text:postText.value,
    likes:[],
    comments:[]
  });
  save("posts",posts);
  postText.value="";
  renderPosts();
}
function renderPosts(){
  posts.innerHTML="";
  db("posts").forEach(p=>{
    const div=document.createElement("div");
    div.className="post";
    div.innerHTML=`
<b>${p.user}</b>
<p>${p.text}</p>
<div class="action">
<span onclick="like(${p.id})">â¤ï¸ ${p.likes.length}</span>
<span onclick="comment(${p.id})">ğŸ’¬ ${p.comments.length}</span>
${p.user!==current?`<span onclick="addFriend('${p.user}')">â• åŠ å¥½å‹</span>`:""}
</div>
<div class="small">
${p.comments.map(c=>`<div>${c.u}: ${c.t}</div>`).join("")}
</div>`;
    posts.appendChild(div);
  });
}
function like(id){
  const posts=db("posts");
  const p=posts.find(x=>x.id===id);
  if(!p.likes.includes(current)) p.likes.push(current);
  save("posts",posts); renderPosts();
}
function comment(id){
  const t=prompt("ç•™è¨€å…§å®¹");
  if(!t) return;
  const posts=db("posts");
  posts.find(x=>x.id===id).comments.push({u:current,t});
  save("posts",posts); renderPosts();
}

/* ---------- å¥½å‹ ---------- */
function addFriend(target){
  if(target===current) return alert("ä¸èƒ½åŠ è‡ªå·±");
  const friends=db("friends");
  if(friends.find(f=>
    (f.a===current&&f.b===target)||(f.a===target&&f.b===current)
  )) return alert("å·²æ˜¯å¥½å‹");
  friends.push({a:current,b:target,time:Date.now()});
  save("friends",friends);
  alert("âœ… åŠ å¥½å‹æˆåŠŸ");
  loadProfile();
}
</script>
</body>
</html>
