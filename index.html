<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>City Social</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{--bg:#0b0f14;--card:#111c;--text:#fff}
.light{--bg:#f4f4f4;--card:#fff;--text:#000}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont;background-color:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:10;background:var(--card);padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
main{max-width:520px;margin:auto;padding:12px;padding-bottom:90px}
.card{background:var(--card);border-radius:18px;padding:14px;margin-bottom:14px}
input,textarea{width:100%;padding:10px;margin:6px 0;border-radius:12px;border:1px solid #444;background:transparent;color:var(--text)}
button{border:none;border-radius:20px;padding:6px 14px;background:#1f6feb;color:#fff;cursor:pointer}
.hidden{display:none}
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);display:flex;justify-content:space-around;padding:10px 0;font-size:20px}
.badge{background:red;border-radius:12px;padding:2px 6px;font-size:12px;margin-left:6px}
.chatbox{max-height:50vh;overflow-y:auto}
.msg{max-width:70%;padding:8px 12px;border-radius:16px;margin:6px 0}
.me{background:#1f6feb;margin-left:auto}
.other{background:#333}
.chatimg{max-width:100%;border-radius:12px;margin-top:6px}
.cover{width:100%;height:140px;background:#333;border-radius:18px 18px 0 0;object-fit:cover}
.avatar{width:96px;height:96px;border-radius:50%;border:4px solid var(--card);object-fit:cover;margin-top:-48px}
.center{text-align:center}
.postimg{max-width:100%;border-radius:12px;margin-top:6px}
.small{font-size:13px;opacity:.7}
</style>
</head>
<body>
<header>
  <b>ğŸŒƒ City Social</b>
  <div>
    <span onclick="toggleMode()">ğŸŒ™</span>
    <span onclick="logout()">ç™»å‡º</span>
  </div>
</header>

<main>

<div class="card" id="auth">
  <input id="user" placeholder="å¸³è™Ÿ">
  <input id="pass" type="password" placeholder="å¯†ç¢¼">
  <button onclick="login()">ç™»å…¥ / è¨»å†Š</button>
</div>

<div id="home" class="hidden">
  <div class="card">
    <input id="findUser" placeholder="è¼¸å…¥å¸³è™Ÿ">
    <button onclick="addFriend()">åŠ å¥½å‹</button>
  </div>
  <div class="card">
    <h4>å¥½å‹é‚€è«‹</h4>
    <div id="requests"></div>
  </div>
</div>

<div id="messages" class="hidden">
  <div class="card">
    <h4>å¥½å‹</h4>
    <div id="friends"></div>
  </div>
  <div class="card hidden" id="chat">
    <b id="chatWith"></b>
    <div class="chatbox" id="chatbox"></div>
    <input id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯">
    <input type="file" id="imgInput" accept="image/*">
    <button onclick="sendMsg()">é€å‡º</button>
  </div>
</div>

<div id="profile" class="hidden">
  <div class="card center">
    <img id="coverImg" class="cover">
    <input type="file" id="coverInput" accept="image/*">
    <img id="avatarImg" class="avatar">
    <input type="file" id="avatarInput" accept="image/*">
    <h3 id="profileUser"></h3>
    <div id="profileStats"></div>
  </div>

  <div class="card">
    <textarea id="postText" placeholder="å¯«é»ä»€éº¼â€¦"></textarea>
    <input type="file" id="postImg" accept="image/*">
    <button onclick="addPost()">ç™¼ä½ˆ</button>
  </div>

  <div id="myPosts"></div>
</div>

</main>

<div class="nav hidden" id="nav">
  <div onclick="show('home')">ğŸ </div>
  <div onclick="show('messages')">ğŸ’¬</div>
  <div onclick="show('profile')">ğŸ‘¤</div>
</div>

<script>
let current=null,chatTarget=null;
const users=JSON.parse(localStorage.users||"{}");
const chats=JSON.parse(localStorage.chats||"{}");
const unread=JSON.parse(localStorage.unread||"{}");

function save(){localStorage.users=JSON.stringify(users);localStorage.chats=JSON.stringify(chats);localStorage.unread=JSON.stringify(unread)}
function toggleMode(){document.body.classList.toggle("light");localStorage.mode=document.body.classList.contains("light")?"light":"dark"}

function login(){
  const u=user.value.trim(),p=pass.value;
  if(!u||!p)return alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼");
  if(!users[u])users[u]={pass:p,avatar:"",cover:"",friends:[],requests:[],posts:[]};
  if(users[u].pass!==p)return alert("å¯†ç¢¼éŒ¯");
  current=u;localStorage.current=current;
  auth.classList.add("hidden");nav.classList.remove("hidden");
  show("home");save();render();
}

function logout(){localStorage.removeItem("current");location.reload()}
function show(p){["home","messages","profile"].forEach(id=>document.getElementById(id).classList.add("hidden"));document.getElementById(p).classList.remove("hidden");render()}

function addFriend(){
  const t=findUser.value.trim();
  if(!users[t]||t===current)return alert("ç„¡æ³•åŠ å…¥");
  if(users[t].requests.includes(current)||users[t].friends.includes(current))return alert("å·²é€éæˆ–å·²æ˜¯å¥½å‹");
  users[t].requests.push(current);save();alert("å¥½å‹é‚€è«‹å·²é€å‡º");render();
}
function accept(u){
  if(!users[current].friends.includes(u))users[current].friends.push(u);
  if(!users[u].friends.includes(current))users[u].friends.push(current);
  users[current].requests=users[current].requests.filter(r=>r!==u);
  save();render();
}

function openChat(u){
  chatTarget=u;chat.classList.remove("hidden");chatWith.textContent="èˆ‡ "+u+" èŠå¤©";
  unread[current]=unread[current]||{};unread[current][u]=0;save();renderChat();render();
}

function sendMsg(){
  const key=[current,chatTarget].sort().join("__");
  chats[key]=chats[key]||[];
  const msg={from:current,text:chatInput.value,img:""};
  const f=imgInput.files[0];
  if(f){
    const r=new FileReader();
    r.onload=()=>{msg.img=r.result;chats[key].push(msg);markUnread();}
    r.readAsDataURL(f)
  }else{msg.text=chatInput.value;chats[key].push(msg);markUnread();}
  chatInput.value="";imgInput.value="";
}
function markUnread(){unread[chatTarget]=unread[chatTarget]||{};unread[chatTarget][current]=(unread[chatTarget][current]||0)+1;save();renderChat();render();}
function renderChat(){
  const key=[current,chatTarget].sort().join("__");
  chatbox.innerHTML="";(chats[key]||[]).forEach(m=>{
    chatbox.innerHTML+=`<div class="msg ${m.from===current?"me":"other"}">${m.text||""}${m.img?`<img class="chatimg" src="${m.img}">`:""}</div>`});
  chatbox.scrollTop=9999;
}

/* profile */
function addPost(){
  const text=postText.value,f=postImg.files[0];if(!text&&!f)return;
  const p={text,img:"",time:Date.now()};
  if(f){const r=new FileReader();r.onload=()=>{p.img=r.result;users[current].posts.unshift(p);finishPost();};r.readAsDataURL(f);}
  else{users[current].posts.unshift(p);finishPost();}
}
function finishPost(){postText.value="";postImg.value="";save();render();}

function render(){
  if(!current)return;
  requests.innerHTML="";users[current].requests.forEach(u=>requests.innerHTML+=`<div>${u}<button onclick="accept('${u}')">æ¥å—</button></div>`);
  friends.innerHTML="";users[current].friends.forEach(f=>{const c=unread[current]?.[f]||0;friends.innerHTML+=`<div onclick="openChat('${f}')">${f}${c?`<span class="badge">${c}</span>`:""}</div>`});
  profileUser.textContent=current;
  profileStats.textContent="å¥½å‹ï¼š"+users[current].friends.length;
  avatarImg.src=users[current].avatar||"https://via.placeholder.com/150";
  coverImg.src=users[current].cover||"";

  myPosts.innerHTML="";users[current].posts.forEach(p=>{myPosts.innerHTML+=`<div class="card"><div class="small">${new Date(p.time).toLocaleString()}</div><div>${p.text||""}</div>${p.img?`<img class="postimg" src="${p.img}">`:''}</div>`});
}

/* uploads */
avatarInput.onchange=()=>{const r=new FileReader();r.onload=()=>{users[current].avatar=r.result;save();render()};r.readAsDataURL(avatarInput.files[0])};
coverInput.onchange=()=>{const r=new FileReader();r.onload=()=>{users[current].cover=r.result;save();render()};r.readAsDataURL(coverInput.files[0])};

/* auto login & mode */
if(localStorage.mode==="light")document.body.classList.add("light");
if(localStorage.current&&users[localStorage.current]){current=localStorage.current;auth.classList.add("hidden");nav.classList.remove("hidden");show("home");}
</script>
</body>
</html>

